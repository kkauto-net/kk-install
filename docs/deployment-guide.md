# Deployment Guide

Hướng dẫn build, release và deploy kkcli.

## Build Locally

### Prerequisites
- Go 1.24.2+
- Docker (cho integration tests)
- Make

### Build Commands

```bash
# Build cho platform hiện tại
make build

# Build cho tất cả platforms
make build-all

# Build với version cụ thể
VERSION=v0.1.0 make build

# Run tests
make test

# Run tests với coverage
make test-coverage

# Lint code
make lint

# Format code
make fmt
```

### Build Output
- **Single platform**: `./kk` binary
- **Multi-platform**: `dist/kk-{os}-{arch}` binaries

---

## Release Process

### Automatic Release via GitHub Actions

#### 1. Via PR Merge (Recommended)
```bash
# Tạo PR với conventional commit title
git checkout -b feat/new-feature
git commit -m "feat: add new feature"
git push origin feat/new-feature

# Tạo PR trên GitHub
# Merge PR → Auto version bump → Auto release
```

**Version Bump:**
- `feat:` → Minor bump (v0.1.0 → v0.2.0)
- `fix:` → Patch bump (v0.1.0 → v0.1.1)
- `feat!:` → Major bump (v0.1.0 → v1.0.0)

#### 2. Via Manual Tag
```bash
# Tạo và push tag
git tag -a v0.1.0 -m "Release v0.1.0"
git push origin v0.1.0

# GitHub Actions tự động:
# - Build multi-platform binaries
# - Generate checksums
# - Create GitHub Release
```

#### 3. Via Draft Release Workflow
```bash
# 1. Vào GitHub Actions UI
# 2. Chọn "Draft Release" workflow
# 3. Click "Run workflow"
# 4. Nhập version: v0.1.0
# 5. Review draft release
# 6. Publish khi sẵn sàng
```

### Release Artifacts

Mỗi release bao gồm:
- **Binaries**: `kkcli_{version}_{os}_{arch}.tar.gz`
- **Checksums**: `checksums.txt`
- **Source code**: Auto-generated by GitHub

**Supported Platforms:**
- Linux: amd64, arm64
- macOS (Darwin): amd64, arm64

---

## Manual Release (Without GitHub Actions)

### Using GoReleaser Locally

```bash
# Install GoReleaser
brew install goreleaser/tap/goreleaser

# Test release (dry-run)
goreleaser release --snapshot --clean

# Create release
export GITHUB_TOKEN=your_token
goreleaser release --clean
```

### Manual Build & Package

```bash
# Build all platforms
make build-all

# Create archives
cd dist/
tar -czf kkcli_0.1.0_linux_amd64.tar.gz kk-linux-amd64
tar -czf kkcli_0.1.0_linux_arm64.tar.gz kk-linux-arm64
tar -czf kkcli_0.1.0_darwin_amd64.tar.gz kk-darwin-amd64
tar -czf kkcli_0.1.0_darwin_arm64.tar.gz kk-darwin-arm64

# Generate checksums
sha256sum *.tar.gz > checksums.txt

# Create GitHub release manually
gh release create v0.1.0 \
  --title "Release v0.1.0" \
  --notes "Release notes here" \
  *.tar.gz checksums.txt
```

---

## Installation Methods

### 1. Via Install Script (Recommended)
```bash
curl -sSL https://raw.githubusercontent.com/kkauto-net/kk-install/main/scripts/install.sh | bash
```

**Features:**
- Auto-detect OS/architecture
- Verify checksums
- Install to `/usr/local/bin`
- Request sudo only when needed

### 2. Via GitHub Release
```bash
# Download binary
curl -L "https://github.com/kkauto-net/kk-install/releases/latest/download/kkcli_0.1.0_linux_amd64.tar.gz" -o kkcli.tar.gz

# Extract
tar -xzf kkcli.tar.gz

# Install
sudo mv kk /usr/local/bin/
sudo chmod 755 /usr/local/bin/kk
```

### 3. From Source
```bash
git clone https://github.com/kkauto-net/kk-install.git
cd kk-install
make build
sudo make install
```

---

## CI/CD Pipeline

### Workflows

1. **CI** (`.github/workflows/ci.yml`)
   - Trigger: Push/PR to `main`
   - Jobs: Test, Lint, Build

2. **Release** (`.github/workflows/release.yml`)
   - Trigger: Tag push (`v*.*.*`)
   - Jobs: Build, Package, Publish

3. **Auto Version** (`.github/workflows/auto-version.yml`)
   - Trigger: PR merge to `main`
   - Jobs: Auto tag creation

4. **Draft Release** (`.github/workflows/draft-release.yml`)
   - Trigger: Manual dispatch
   - Jobs: Create draft release

### Configuration

**GoReleaser** (`.goreleaser.yml`):
- Project name: `kkcli`
- Binary name: `kk`
- Archive format: `tar.gz` (zip for Windows)
- Checksum: SHA256

**Makefile**:
- Version injection via `-ldflags`
- Cross-compilation support
- Test coverage reporting

---

## Version Management

### Semantic Versioning

Format: `v{major}.{minor}.{patch}`

- **Major**: Breaking changes
- **Minor**: New features (backward compatible)
- **Patch**: Bug fixes

### Version Injection

Version được inject vào binary qua linker flags:

```bash
# Via Makefile
VERSION=$(git describe --tags --always --dirty)
-X github.com/kkauto-net/kk-install/cmd.Version=$VERSION

# Via GoReleaser
-X github.com/kkauto-net/kk-install/cmd.Version={{.Version}}
```

### Check Version
```bash
kk --version
# Output: kk version v0.1.0
```

---

## Security

### Checksum Verification

**Install script** tự động verify checksums:
```bash
sha256sum -c checksums.txt
```

**Manual verification:**
```bash
# Download checksum file
curl -L "https://github.com/kkauto-net/kk-install/releases/download/v0.1.0/checksums.txt" -o checksums.txt

# Verify
sha256sum -c checksums.txt
```

### Signed Releases

(Future enhancement)
- GPG signing of binaries
- Cosign signatures for container images

---

## Troubleshooting

### Build Fails

**Issue:** `go build` fails
```bash
# Clean and rebuild
make clean
go mod tidy
make build
```

**Issue:** Version shows as "dev"
```bash
# Create annotated tag first
git tag -a v0.1.0 -m "Release v0.1.0"
make build
```

### Release Fails

**Issue:** GoReleaser fails on tag
- Verify tag format: `v{major}.{minor}.{patch}`
- Check `.goreleaser.yml` syntax
- Ensure `go.mod` is committed

**Issue:** GitHub token expired
```bash
# Create new token with repo permissions
export GITHUB_TOKEN=new_token
goreleaser release
```

### Installation Issues

**Issue:** Checksum mismatch
- Re-download binary
- Verify download URL
- Check internet connection stability

**Issue:** Permission denied
```bash
# Use sudo for installation
sudo chmod 755 /usr/local/bin/kk
```

---

## Next Steps

After deployment:
1. ✅ Tag and release v0.1.0
2. ✅ Test installation script
3. ✅ Update documentation
4. ⏳ Setup monitoring/analytics
5. ⏳ Add auto-update feature (`kk self-update`)
